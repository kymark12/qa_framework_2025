name: Cleanup Old Reports

on:
  schedule:
    - cron: "0 3 * * 1"  # Every Monday at 3 AM UTC
  workflow_dispatch:     # Allow manual run from the Actions tab

jobs:
  cleanup:
    runs-on: ubuntu-22.04
    env:
      REPORT_BRANCH: reports
      KEEP_COUNT: 20  # Number of most recent reports to keep
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0
          persist-credentials: true
          ref: ${{ env.REPORT_BRANCH }}

      - name: Clean up old archived reports
        run: |
          set -euo pipefail
          cd reports/archive || exit 0

          TOTAL=$(ls -1 *.json 2>/dev/null | wc -l || true)
          if [ "$TOTAL" -le "$KEEP_COUNT" ]; then
            echo "No cleanup needed (only $TOTAL archives, keeping $KEEP_COUNT)"
            exit 0
          fi

          echo "Total archives: $TOTAL, keeping latest $KEEP_COUNT"
          # Sort by modification time, keep newest $KEEP_COUNT, delete the rest
          ls -1t *.json | tail -n +$((KEEP_COUNT + 1)) | xargs -r rm -f

          cd ../..
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git add reports/archive
          git commit -m "Cleanup old archived reports (keep $KEEP_COUNT most recent)" || echo "No changes to commit"
          git push origin HEAD:${REPORT_BRANCH}
